<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<head>
    <title>Demo</title>
    <link rel="shortcut icon" href="#">
</head>
<body>
    <script type="module">
        import init, { zeronym_init, 
                       setup_zk_proof, 
                       cred_gen, 
                       cred_commit,
                       create_list,
                       insert_into_list,
                       get_path,
                       get_proof,
                       verify,
                       randomize } from './pkg/zeronym.js';
            await init();

            zeronym_init();

            console.log("Generating public and virtual key:");
            let log_capacity = 32;
            let json_pk_and_vk = setup_zk_proof(log_capacity);
            console.log("done.");
            console.log(json_pk_and_vk);

            console.log("Generating a credential and commiting it:")
            let json_cred = cred_gen();
            let json_com_and_comnonce = cred_commit(json_cred);
            console.log("done.");
            console.log(json_cred);
            console.log(json_com_and_comnonce);

            console.log("Making a list and inserting it:");
            let first_free_idx = BigInt(0);
            let json_global_list = create_list(log_capacity);
            json_global_list = insert_into_list(json_global_list, 
                                                json_com_and_comnonce, 
                                                first_free_idx);
            let inserted_cred_idx = first_free_idx;
            console.log("done.");
            console.log(json_global_list);

            console.log("Getting the auth path and creating a ZK proof:")
            let json_auth_path = get_path(json_global_list, 
                                     json_com_and_comnonce, 
                                     first_free_idx);
            let json_membership_proof = get_proof(json_auth_path,
                                                  json_pk_and_vk,
                                                  json_com_and_comnonce);
            console.log("done.");
            console.log(json_auth_path);
            console.log(json_membership_proof);

            console.log("Verify proof:");
            console.assert(verify(json_global_list, 
                                  json_pk_and_vk, 
                                  json_membership_proof));
            console.log("done.");

            console.log("Rerandomize proof and verify again:");
            json_membership_proof = randomize(json_pk_and_vk, json_membership_proof);
            console.assert(verify(json_global_list, 
                                  json_pk_and_vk, 
                                  json_membership_proof));
            console.log("done.");

            console.log("Remove credential and verify proof NOT valid:");
            json_global_list = remove_from_list(json_global_list, inserted_cred_idx);
            console.assert(!verify(json_global_list, 
                                  json_pk_and_vk, 
                                  json_membership_proof));
            console.log("done.")





            console.log("yayyyyyy");


    </script>
</body>
</html>

